<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gomoku</title>
<script src="https://cdn.tailwindcss.com"></script>
</head><body class="bg-gray-50 text-gray-900">
<main class="max-w-lg mx-auto mt-8">
  <h1 class="text-2xl font-bold mb-3">Gomoku (Five-in-a-Row)</h1>
  <p class="text-sm text-gray-600 mb-2">Black goes first. Click to place stones. First to 5 in a row wins.</p>
  <canvas id="cv" width="450" height="450" class="bg-white border rounded-xl"></canvas>
</main>
<script src="../assets/js/api.js"></script>
<script>
requireLoginOrRedirect();
const TITLE='Gomoku'; let GAME_ID=null;
async function ensureAllowed(){
  const {games}=await api('games.php?action=list');
  const g=games.find(x=>x.title===TITLE); if(!g){ alert('Game not found.'); location.href='../library.html'; return false; }
  GAME_ID=g.id; const r=await api('games.php?action=can_play&game_id='+GAME_ID);
  if(!r.allowed){ alert('Add "'+TITLE+'" to your library first.'); location.href='../library.html'; return false; }
  return true;
}

(async ()=>{
if(!(await ensureAllowed())) return;

const N=15, c=cv, ctx=c.getContext('2d'); const W=c.width,H=c.height; const cell=W/(N+1);
const board=[...Array(N)].map(()=>Array(N).fill(0));
let turn=1, over=false; // 1 black, 2 white

function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#fef3c7'; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='#9ca3af';
  for(let i=1;i<=N;i++){
    ctx.beginPath(); ctx.moveTo(cell,i*cell); ctx.lineTo(N*cell,i*cell); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(i*cell,cell); ctx.lineTo(i*cell,N*cell); ctx.stroke();
  }
  for(let r=0;r<N;r++)for(let col=0;col<N;col++){
    const v=board[r][col]; if(!v) continue;
    ctx.beginPath(); ctx.arc((col+1)*cell,(r+1)*cell,cell*0.4,0,Math.PI*2);
    ctx.fillStyle = v===1 ? '#111827' : '#e5e7eb'; ctx.fill();
    ctx.strokeStyle='#111827'; ctx.stroke();
  }
}

function place(x,y){
  if(over) return;
  const col=Math.round(x/cell)-1, r=Math.round(y/cell)-1;
  if(r<0||r>=N||col<0||col>=N||board[r][col]) return;
  board[r][col]=turn; turn=turn===1?2:1; if(checkWin(r,col)) end(board[r][col]); draw();
}

function checkWin(r,c){
  const p=board[r][c]; if(!p) return false;
  const dirs=[[1,0],[0,1],[1,1],[1,-1]];
  function count(dr,dc){ let k=1;
    for(let s=1;s<5;s++){ const rr=r+dr*s, cc=c+dc*s; if(rr<0||rr>=N||cc<0||cc>=N||board[rr][cc]!==p) break; k++; }
    for(let s=1;s<5;s++){ const rr=r-dr*s, cc=c-dc*s; if(rr<0||rr>=N||cc<0||cc>=N||board[rr][cc]!==p) break; k++; }
    return k;
  }
  return dirs.some(([dr,dc])=>count(dr,dc)>=5);
}

async function end(player){
  over=true;
  const pts=120; const fd=new FormData(); fd.append('game_id', GAME_ID); fd.append('score', pts);
  await fetch(__API_BASE__+'scores.php?action=submit',{method:'POST', body:fd});
  alert((player===1?'Black':'White')+' wins! +'+pts+' points.'); location.href='../library.html';
}

c.addEventListener('click',e=>{
  const rect=c.getBoundingClientRect();
  place(e.clientX-rect.left, e.clientY-rect.top);
});
draw();
})();
</script>
</body></html>
